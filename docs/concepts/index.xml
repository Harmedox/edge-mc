<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>KCP-Edge â€“ Concepts</title><link>https://docs.kcp-edge.io/public/docs/concepts/</link><description>Recent content in Concepts on KCP-Edge</description><generator>Hugo -- gohugo.io</generator><atom:link href="https://docs.kcp-edge.io/public/docs/concepts/index.xml" rel="self" type="application/rss+xml"/><item><title>Docs: Edge Scheduler</title><link>https://docs.kcp-edge.io/public/docs/concepts/edge-scheduler/</link><pubDate>Thu, 02 Feb 2023 00:00:00 +0000</pubDate><guid>https://docs.kcp-edge.io/public/docs/concepts/edge-scheduler/</guid><description>
&lt;div class="pageinfo pageinfo-primary">
&lt;p>The edge scheduler monitors the EdgePlacement, Location, and SyncTarget objects and maintains the results of matching.
It starts from the kcp-scheduling-placement controller forked from kcp-dev/kcp, now being refactored towards the goal above.
It works with &lt;a href="https://github.com/kcp-dev/kcp/tree/4506fdc064060b3fe82e1082533f9798b36ba7a5">this snapshot&lt;/a> of kcp.&lt;/p>
&lt;/div>
&lt;h4 id="a-short-demo">A short demo&lt;/h4>
&lt;p>Start a kcp server with &lt;a href="https://github.com/kcp-dev/kcp/tree/4506fdc064060b3fe82e1082533f9798b36ba7a5">this snapshot&lt;/a>.&lt;/p>
&lt;p>Point &lt;code>$KUBECONFIG&lt;/code> to the admin kubeconfig for that kcp server.&lt;/p>
&lt;p>Workspace &lt;code>root:edge&lt;/code> is used as the edge service provider workspace.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-console" data-lang="console">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">kubectl ws root
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">kubectl ws create edge --enter
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Install CRDs and APIExport.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-console" data-lang="console">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">kubectl apply -f config/crds/ -f config/exports/
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>User home workspace is used as the workload management workspace.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-console" data-lang="console">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">kubectl ws \~
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Bind APIs and create an EdgePlacement CR.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-console" data-lang="console">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">kubectl apply -f config/imports/
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">kubectl apply -f config/samples/edgeplacement_test-1.yaml
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Go to &lt;code>root:edge&lt;/code> workspace and run the edge scheduler.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-console" data-lang="console">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">kubectl ws root:edge
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">go run cmd/placement/main.go --kcp-kubeconfig=&amp;lt;path to kcp admin kubeconfig&amp;gt; -v &amp;lt;verbosity (default 2)&amp;gt;
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>The outputs from the edge scheduler should be similar to:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-console" data-lang="console">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">I0214 17:09:54.739592 50397 placement.go:207] &amp;#34;Found APIExport view&amp;#34; exportName=&amp;#34;edge.kcp.io&amp;#34; serverURL=&amp;#34;https://192.168.1.54:6443/services/apiexport/21rzp91t9ife44tq/edge.kcp.io&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">I0214 17:09:54.755028 50397 controller.go:182] &amp;#34;queueing EdgePlacement&amp;#34; reconciler=&amp;#34;edge-scheduler&amp;#34; key=&amp;#34;kvdk2spgmbix|test-1&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">I0214 17:09:54.841368 50397 controller.go:257] &amp;#34;Starting controller&amp;#34; reconciler=&amp;#34;edge-scheduler&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">I0214 17:09:54.841492 50397 controller.go:282] &amp;#34;processing key&amp;#34; reconciler=&amp;#34;edge-scheduler&amp;#34; key=&amp;#34;kvdk2spgmbix|test-1&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">reconciling EdgePlacement test-1 in Workspace kvdk2spgmbix
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Go to &lt;code>\~&lt;/code> and edit or delete the EdgePlacement.&lt;/p>
&lt;pre tabindex="0">&lt;code>kubectl ws \~
kubectl edit edgeplacement test-1
kubectl delete edgeplacement test-1
&lt;/code>&lt;/pre>&lt;p>Additional outputs from the edge scheduler should be similar to:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-console" data-lang="console">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">I0214 17:10:12.404611 50397 controller.go:182] &amp;#34;queueing EdgePlacement&amp;#34; reconciler=&amp;#34;edge-scheduler&amp;#34; key=&amp;#34;kvdk2spgmbix|test-1&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">I0214 17:10:12.404634 50397 controller.go:282] &amp;#34;processing key&amp;#34; reconciler=&amp;#34;edge-scheduler&amp;#34; key=&amp;#34;kvdk2spgmbix|test-1&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">reconciling EdgePlacement test-1 in Workspace kvdk2spgmbix
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">I0214 17:11:21.744670 50397 controller.go:182] &amp;#34;queueing EdgePlacement&amp;#34; reconciler=&amp;#34;edge-scheduler&amp;#34; key=&amp;#34;kvdk2spgmbix|test-1&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">I0214 17:11:21.744695 50397 controller.go:282] &amp;#34;processing key&amp;#34; reconciler=&amp;#34;edge-scheduler&amp;#34; key=&amp;#34;kvdk2spgmbix|test-1&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#000;font-style:italic">I0214 17:11:21.744722 50397 controller.go:308] &amp;#34;object deleted before handled&amp;#34; reconciler=&amp;#34;edge-scheduler&amp;#34; key=&amp;#34;kvdk2spgmbix|test-1&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Docs: Mailbox Controller</title><link>https://docs.kcp-edge.io/public/docs/concepts/mailbox-controller/</link><pubDate>Thu, 02 Feb 2023 00:00:00 +0000</pubDate><guid>https://docs.kcp-edge.io/public/docs/concepts/mailbox-controller/</guid><description>
&lt;div class="pageinfo pageinfo-primary">
&lt;p>The mailbox controller runs in the edge service provider workspace and maintains a child workspace per SyncTarget.&lt;/p>
&lt;/div>
&lt;h4 id="temporary-design-detail">Temporary design detail&lt;/h4>
&lt;p>For a given SyncTarget T, the mailbox controller currently chooses the
name of the corresponding workspace to be the concatenation of the
following.&lt;/p>
&lt;ul>
&lt;li>the ID of the logical cluster containing T&lt;/li>
&lt;li>the string &amp;ldquo;-w-&amp;rdquo;&lt;/li>
&lt;li>T&amp;rsquo;s name&lt;/li>
&lt;/ul>
&lt;p>This is ambiguous and subject to name length overflows. Later
revisions will do better.&lt;/p>
&lt;h4 id="usage">Usage&lt;/h4>
&lt;p>The command line flags, beyond the basics, are as follows.&lt;/p>
&lt;pre tabindex="0">&lt;code> --concurrency int number of syncs to run in parallel (default 4)
--inventory-context string current-context override for inventory-kubeconfig (default &amp;#34;root&amp;#34;)
--inventory-kubeconfig string pathname of kubeconfig file for inventory service provider workspace
--server-bind-address ipport The IP address with port at which to serve /metrics and /debug/pprof/ (default :10203)
--workload-context string current-context override for workload-kubeconfig
--workload-kubeconfig string pathname of kubeconfig file for edge workload service provider workspace
&lt;/code>&lt;/pre>&lt;h4 id="try-it">Try It&lt;/h4>
&lt;p>To exercise it, do the following steps.&lt;/p>
&lt;p>Start a kcp server. Do the remaining steps in a separate shell, with
&lt;code>$KUBECONFIG&lt;/code> set to the admin config for that kcp server.&lt;/p>
&lt;p>&lt;code>kubectl ws root&lt;/code>&lt;/p>
&lt;p>&lt;code>kubectl ws create edge --enter&lt;/code>&lt;/p>
&lt;p>After that, a run of the controller should look like the following.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>base&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> mspreitz@mjs12 edge-mc % go run ./cmd/mailbox-controller -v&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>I0127 00:21:48.876022 &lt;span style="color:#0000cf;font-weight:bold">24503&lt;/span> main.go:206&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Found APIExport view&amp;#34;&lt;/span> &lt;span style="color:#000">exportName&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;workload.kcp.io&amp;#34;&lt;/span> &lt;span style="color:#000">serverURL&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span>&lt;span style="color:#4e9a06">&amp;#34;https://192.168.58.123:6443/services/apiexport/root/workload.kcp.io&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>I0127 00:21:48.877965 &lt;span style="color:#0000cf;font-weight:bold">24503&lt;/span> shared_informer.go:255&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> Waiting &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> caches to sync &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> mailbox-controller
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>I0127 00:21:48.978352 &lt;span style="color:#0000cf;font-weight:bold">24503&lt;/span> shared_informer.go:262&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> Caches are synced &lt;span style="color:#204a87;font-weight:bold">for&lt;/span> mailbox-controller
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>I0127 00:21:48.978414 &lt;span style="color:#0000cf;font-weight:bold">24503&lt;/span> main.go:169&lt;span style="color:#ce5c00;font-weight:bold">]&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;Informers synced&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>In a separate shell, &lt;code>kubectl create&lt;/code> the following object.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#204a87;font-weight:bold">apiVersion&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">workload.kcp.io/v1alpha1&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">kind&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">SyncTarget&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">metadata&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">name&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">stest1&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline">&lt;/span>&lt;span style="color:#204a87;font-weight:bold">spec&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">cells&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#204a87;font-weight:bold">foo&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline"> &lt;/span>&lt;span style="color:#000">bar&lt;/span>&lt;span style="color:#f8f8f8;text-decoration:underline">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>That should provoke logging like the following from the mailbox controller.&lt;/p>
&lt;pre tabindex="0">&lt;code>I0127 00:23:52.545266 24503 main.go:330] &amp;#34;Created missing workspace&amp;#34; worker=1 wsName=&amp;#34;269p7excqtb3xen8-w-stest1&amp;#34;
&lt;/code>&lt;/pre>&lt;p>And you can verify that like so.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ce5c00;font-weight:bold">(&lt;/span>base&lt;span style="color:#ce5c00;font-weight:bold">)&lt;/span> mspreitz@mjs12 kcp % kubectl get Workspace
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>NAME TYPE PHASE URL AGE
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>269p7excqtb3xen8-w-stest1 universal https://192.168.58.123:6443/clusters/2ktljajura89bwf2 29s
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Next, &lt;code>kubectl delete&lt;/code> that Workspace, and watch the mailbox
controller wait for it to be gone and then re-create it.&lt;/p>
&lt;pre tabindex="0">&lt;code>I0127 00:26:40.251001 24503 main.go:330] &amp;#34;Created missing workspace&amp;#34; worker=2 wsName=&amp;#34;269p7excqtb3xen8-w-stest1&amp;#34;
&lt;/code>&lt;/pre>&lt;p>Finally, &lt;code>kubectl delete SyncTarget stest1&lt;/code> and watch the mailbox
controller react as follows.&lt;/p>
&lt;pre tabindex="0">&lt;code>I0127 00:26:59.369990 24503 main.go:311] &amp;#34;Deleted unwanted workspace&amp;#34; worker=1 wsName=&amp;#34;269p7excqtb3xen8-w-stest1&amp;#34;
&lt;/code>&lt;/pre></description></item></channel></rss>