<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.111.1"><link rel=canonical type=text/html href=https://docs.kcp-edge.io/docs/concepts/><link rel=alternate type=application/rss+xml href=https://docs.kcp-edge.io/docs/concepts/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Concepts | KCP-Edge</title><meta name=description content="Key concepts and design information. 
"><meta property="og:title" content="Concepts"><meta property="og:description" content="Key concepts and design information. 
"><meta property="og:type" content="website"><meta property="og:url" content="https://docs.kcp-edge.io/docs/concepts/"><meta property="og:site_name" content="KCP-Edge"><meta itemprop=name content="Concepts"><meta itemprop=description content="Key concepts and design information. 
"><meta name=twitter:card content="summary"><meta name=twitter:title content="Concepts"><meta name=twitter:description content="Key concepts and design information. 
"><link rel=preload href=/scss/main.min.def2cdda5cfcd95d9660c969a68946395435ad5fc75402be473d9995c7e926b3.css as=style><link href=/scss/main.min.def2cdda5cfcd95d9660c969a68946395435ad5fc75402be473d9995c7e926b3.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>KCP-Edge</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>Blog</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/community/><span>Community</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><div class=td-search><div class=td-search__icon></div><input type=search class="td-search__input form-control td-search-input" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/docs/concepts/>Return to the regular view of this page</a>.</p></div><h1 class=title>Concepts</h1><div class=lead>Key concepts and design information.</div><ul><li>1: <a href=#pg-90a397b0c06c4f747c7c6d6e85443037>Edge Scheduler</a></li><li>2: <a href=#pg-9b7113ded28825a6400b1d0583c67384>Mailbox Controller</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-90a397b0c06c4f747c7c6d6e85443037>1 - Edge Scheduler</h1><div class="pageinfo pageinfo-primary"><p>The edge scheduler monitors the EdgePlacement, Location, and SyncTarget objects and maintains the results of matching.
It starts from the kcp-scheduling-placement controller forked from kcp-dev/kcp, now being refactored towards the goal above.
It works with <a href=https://github.com/kcp-dev/kcp/tree/4506fdc064060b3fe82e1082533f9798b36ba7a5>this snapshot</a> of kcp.</p></div><h4 id=a-short-demo>A short demo</h4><p>Start a kcp server with <a href=https://github.com/kcp-dev/kcp/tree/4506fdc064060b3fe82e1082533f9798b36ba7a5>this snapshot</a>.</p><p>Point <code>$KUBECONFIG</code> to the admin kubeconfig for that kcp server.</p><p>Workspace <code>root:edge</code> is used as the edge service provider workspace.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>kubectl ws root
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>kubectl ws create edge --enter
</span></span></span></code></pre></div><p>Install CRDs and APIExport.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>kubectl apply -f config/crds/ -f config/exports/
</span></span></span></code></pre></div><p>User home workspace is used as the workload management workspace.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>kubectl ws \~
</span></span></span></code></pre></div><p>Bind APIs and create an EdgePlacement CR.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>kubectl apply -f config/imports/
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>kubectl apply -f config/samples/edgeplacement_test-1.yaml
</span></span></span></code></pre></div><p>Go to <code>root:edge</code> workspace and run the edge scheduler.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>kubectl ws root:edge
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>go run cmd/placement/main.go --kcp-kubeconfig=&lt;path to kcp admin kubeconfig&gt; -v &lt;verbosity (default 2)&gt;
</span></span></span></code></pre></div><p>The outputs from the edge scheduler should be similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>I0214 17:09:54.739592   50397 placement.go:207] &#34;Found APIExport view&#34; exportName=&#34;edge.kcp.io&#34; serverURL=&#34;https://192.168.1.54:6443/services/apiexport/21rzp91t9ife44tq/edge.kcp.io&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>I0214 17:09:54.755028   50397 controller.go:182] &#34;queueing EdgePlacement&#34; reconciler=&#34;edge-scheduler&#34; key=&#34;kvdk2spgmbix|test-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>I0214 17:09:54.841368   50397 controller.go:257] &#34;Starting controller&#34; reconciler=&#34;edge-scheduler&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>I0214 17:09:54.841492   50397 controller.go:282] &#34;processing key&#34; reconciler=&#34;edge-scheduler&#34; key=&#34;kvdk2spgmbix|test-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>reconciling EdgePlacement test-1 in Workspace kvdk2spgmbix
</span></span></span></code></pre></div><p>Go to <code>\~</code> and edit or delete the EdgePlacement.</p><pre tabindex=0><code>kubectl ws \~
kubectl edit edgeplacement test-1
kubectl delete edgeplacement test-1
</code></pre><p>Additional outputs from the edge scheduler should be similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span><span style=color:#000;font-style:italic>I0214 17:10:12.404611   50397 controller.go:182] &#34;queueing EdgePlacement&#34; reconciler=&#34;edge-scheduler&#34; key=&#34;kvdk2spgmbix|test-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>I0214 17:10:12.404634   50397 controller.go:282] &#34;processing key&#34; reconciler=&#34;edge-scheduler&#34; key=&#34;kvdk2spgmbix|test-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>reconciling EdgePlacement test-1 in Workspace kvdk2spgmbix
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>I0214 17:11:21.744670   50397 controller.go:182] &#34;queueing EdgePlacement&#34; reconciler=&#34;edge-scheduler&#34; key=&#34;kvdk2spgmbix|test-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>I0214 17:11:21.744695   50397 controller.go:282] &#34;processing key&#34; reconciler=&#34;edge-scheduler&#34; key=&#34;kvdk2spgmbix|test-1&#34;
</span></span></span><span style=display:flex><span><span style=color:#000;font-style:italic>I0214 17:11:21.744722   50397 controller.go:308] &#34;object deleted before handled&#34; reconciler=&#34;edge-scheduler&#34; key=&#34;kvdk2spgmbix|test-1&#34;
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9b7113ded28825a6400b1d0583c67384>2 - Mailbox Controller</h1><div class="pageinfo pageinfo-primary"><p>The mailbox controller runs in the edge service provider workspace and maintains a child workspace per SyncTarget.</p></div><h4 id=temporary-design-detail>Temporary design detail</h4><p>For a given SyncTarget T, the mailbox controller currently chooses the
name of the corresponding workspace to be the concatenation of the
following.</p><ul><li>the ID of the logical cluster containing T</li><li>the string &ldquo;-w-&rdquo;</li><li>T&rsquo;s name</li></ul><p>This is ambiguous and subject to name length overflows. Later
revisions will do better.</p><h4 id=usage>Usage</h4><p>The command line flags, beyond the basics, are as follows.</p><pre tabindex=0><code>      --concurrency int                  number of syncs to run in parallel (default 4)
      --inventory-context string         current-context override for inventory-kubeconfig (default &#34;root&#34;)
      --inventory-kubeconfig string      pathname of kubeconfig file for inventory service provider workspace
      --server-bind-address ipport       The IP address with port at which to serve /metrics and /debug/pprof/ (default :10203)
      --workload-context string          current-context override for workload-kubeconfig
      --workload-kubeconfig string       pathname of kubeconfig file for edge workload service provider workspace
</code></pre><h4 id=try-it>Try It</h4><p>To exercise it, do the following steps.</p><p>Start a kcp server. Do the remaining steps in a separate shell, with
<code>$KUBECONFIG</code> set to the admin config for that kcp server.</p><p><code>kubectl ws root</code></p><p><code>kubectl ws create edge --enter</code></p><p>After that, a run of the controller should look like the following.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span>base<span style=color:#ce5c00;font-weight:700>)</span> mspreitz@mjs12 edge-mc % go run ./cmd/mailbox-controller -v<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>I0127 00:21:48.876022   <span style=color:#0000cf;font-weight:700>24503</span> main.go:206<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#4e9a06>&#34;Found APIExport view&#34;</span> <span style=color:#000>exportName</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;workload.kcp.io&#34;</span> <span style=color:#000>serverURL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;https://192.168.58.123:6443/services/apiexport/root/workload.kcp.io&#34;</span>
</span></span><span style=display:flex><span>I0127 00:21:48.877965   <span style=color:#0000cf;font-weight:700>24503</span> shared_informer.go:255<span style=color:#ce5c00;font-weight:700>]</span> Waiting <span style=color:#204a87;font-weight:700>for</span> caches to sync <span style=color:#204a87;font-weight:700>for</span> mailbox-controller
</span></span><span style=display:flex><span>I0127 00:21:48.978352   <span style=color:#0000cf;font-weight:700>24503</span> shared_informer.go:262<span style=color:#ce5c00;font-weight:700>]</span> Caches are synced <span style=color:#204a87;font-weight:700>for</span> mailbox-controller
</span></span><span style=display:flex><span>I0127 00:21:48.978414   <span style=color:#0000cf;font-weight:700>24503</span> main.go:169<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#4e9a06>&#34;Informers synced&#34;</span>
</span></span></code></pre></div><p>In a separate shell, <code>kubectl create</code> the following object.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>workload.kcp.io/v1alpha1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SyncTarget</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>stest1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cells</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>foo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>That should provoke logging like the following from the mailbox controller.</p><pre tabindex=0><code>I0127 00:23:52.545266   24503 main.go:330] &#34;Created missing workspace&#34; worker=1 wsName=&#34;269p7excqtb3xen8-w-stest1&#34;
</code></pre><p>And you can verify that like so.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span>base<span style=color:#ce5c00;font-weight:700>)</span> mspreitz@mjs12 kcp % kubectl get Workspace
</span></span><span style=display:flex><span>NAME                        TYPE        PHASE   URL                                                     AGE
</span></span><span style=display:flex><span>269p7excqtb3xen8-w-stest1   universal           https://192.168.58.123:6443/clusters/2ktljajura89bwf2   29s
</span></span></code></pre></div><p>Next, <code>kubectl delete</code> that Workspace, and watch the mailbox
controller wait for it to be gone and then re-create it.</p><pre tabindex=0><code>I0127 00:26:40.251001   24503 main.go:330] &#34;Created missing workspace&#34; worker=2 wsName=&#34;269p7excqtb3xen8-w-stest1&#34;
</code></pre><p>Finally, <code>kubectl delete SyncTarget stest1</code> and watch the mailbox
controller react as follows.</p><pre tabindex=0><code>I0127 00:26:59.369990   24503 main.go:311] &#34;Deleted unwanted workspace&#34; worker=1 wsName=&#34;269p7excqtb3xen8-w-stest1&#34;
</code></pre></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list"><a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/kcp-users aria-label="User mailing list"><i class="fa fa-envelope"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="YouTube Channel" aria-label="YouTube Channel"><a class=text-white target=_blank rel=noopener href="https://www.youtube.com/playlist?list=PL1ALKGr_qZKc9jyv1EfOFNfoAJo9Q6Ebd" aria-label="YouTube Channel"><i class="fab fa-youtube"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Medium Blog Series" aria-label="Medium Blog Series"><a class=text-white target=_blank rel=noopener href=https://kcp-edge.medium.com/ aria-label="Medium Blog Series"><i class="fab fa-medium"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=LinkedIn aria-label=LinkedIn><a class=text-white target=_blank rel=noopener href="https://www.linkedin.com/feed/hashtag/?keywords=kcpedge" aria-label=LinkedIn><i class="fab fa-linkedin"></i></a></li></ul></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/kcp-dev/edge-mc aria-label=GitHub><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel=noopener href=https://app.slack.com/client/T09NY5SBT/C021U8WSAFK aria-label=Slack><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Developer mailing list" aria-label="Developer mailing list"><a class=text-white target=_blank rel=noopener href=https://groups.google.com/g/kcp-dev aria-label="Developer mailing list"><i class="fa fa-envelope"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 KCP-Edge All Rights Reserved</small>
<small class=ml-1><a href=https://policies.google.com/privacy target=_blank rel=noopener>Privacy Policy</a></small><p class=mt-2><a href=/about/>About KCP-Edge</a></p></div></div></div></footer></div><script src=/js/main.min.df7f14c80afb907c6a8407b070047551586c23dc2f91b17b6e81e7679ff158cb.js integrity="sha256-338UyAr7kHxqhAewcAR1UVhsI9wvkbF7boHnZ5/xWMs=" crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script></body></html>